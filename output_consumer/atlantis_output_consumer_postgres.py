import os
import json
from kafka import KafkaConsumer
import psycopg2
from psycopg2 import sql

# Get environment variables
OUTPUT_TOPIC = os.getenv('OUTPUT_TOPIC', 'output_topic')
KAFKA_BOOTSTRAP_SERVERS = os.getenv('KAFKA_BOOTSTRAP_SERVERS', 'kafka:29092')
WINDOW_DURATION_STR = os.getenv('WINDOW_DURATION', '10 seconds')
SLIDE_DURATION_STR = os.getenv('SLIDE_DURATION', '10 seconds')
GAP_DURATION_STR = os.getenv('GAP_DURATION', '5 seconds')
WINDOW_TYPE = os.getenv('WINDOW_TYPE', 'tumbling').lower()
NUM_CORES = os.getenv('SPARK_NUM_CORES', '20')
NUM_THREADS = os.getenv('NUM_THREADS', '1')
EXPERIMENT_TYPE = os.getenv('EXPERIMENT_TYPE', 'kafka')
MEMORY_LIMIT = os.getenv('MEMORY_LIMIT', '8G')

# Postgres environment variables
PG_HOST = os.getenv('POSTGRES_HOST', 'postgres')
PG_PORT = int(os.getenv('POSTGRES_PORT', '5432'))
PG_DB = os.getenv('POSTGRES_DB', 'dq_db')
PG_USER = os.getenv('POSTGRES_USER', 'dq_user')
PG_PASSWORD = os.getenv('POSTGRES_PASSWORD', 'dq_pass')
PERFORMANCE_TABLE_NAME = os.getenv('PERFORMANCE_TABLE', 'final_performance')
STREAMDAQ_TABLE = os.getenv('STREAMDAQ_TABLE', 'streamdaq_output')


def get_window_short_name(window_type: str, window_duration: str, slide_duration: str | None,
                         gap_duration: str | None) -> str:
    window_type = str(window_type).lower()
    match window_type:
        case "tumbling":
            return f"{window_type}_{window_duration}"
        case "sliding":
            return f"{window_type}_{window_duration}_{slide_duration}"
        case "session":
            return f"{window_type}_{window_duration}_{gap_duration}"

print(f"Starting output consumer. Listening to topic: {OUTPUT_TOPIC}")
print(f"Kafka bootstrap servers: {KAFKA_BOOTSTRAP_SERVERS}")


def create_performance_table_if_not_exists(conn):
    create_sql = sql.SQL("""
    CREATE TABLE IF NOT EXISTS {table} (
        id SERIAL PRIMARY KEY,
        window_start BIGINT,
        window_end BIGINT,
        window_setting TEXT,
        number_of_cores TEXT,
        number_of_threads TEXT,
        latency REAL,
        throughput REAL,
        created_at TIMESTAMPTZ DEFAULT now()
    );
    """).format(table=sql.Identifier(PERFORMANCE_TABLE_NAME))
    with conn.cursor() as cur:
        cur.execute(create_sql)
    conn.commit()

def create_dq_table_if_not_exists(conn):
    create_sql = sql.SQL("""
    CREATE TABLE IF NOT EXISTS {table} (
    id SERIAL PRIMARY KEY,
    window_start BIGINT,
    window_end BIGINT,
    angle_0_count BIGINT,
    angle_1_mean REAL,
    angle_2_count BIGINT,
    angle_3_count BIGINT,
    angle_4_count BIGINT,
    angle_5_count BIGINT,
    angle_6_mean REAL,
    angle_7_mean REAL,
    angle_8_mean REAL,
    angle_9_min REAL,
    angle_10_min REAL,
    angle_11_min REAL,
    angle_12_min REAL,
    angle_13_min REAL,
    angle_14_max REAL,
    angle_15_max REAL,
    angle_16_count BIGINT,
    angle_17_count BIGINT,
    angle_18_count BIGINT,
    angle_19_count BIGINT,
    angle_20_count BIGINT,
    angle_21_count BIGINT,
    angle_22_count BIGINT,
    angle_23_count BIGINT,
    angle_24_count BIGINT,
    angle_25_count BIGINT,
    angle_26_count BIGINT,
    angle_27_count BIGINT,
    angle_28_count BIGINT,
    angle_29_count BIGINT,
    angle_30_count BIGINT,
    angle_31_count BIGINT,
    angle_32_count BIGINT,
    angle_33_max REAL,
    angle_34_max REAL,
    angle_35_max REAL,
    angle_36_mean REAL,
    angle_37_mean REAL,
    angle_38_mean REAL,
    angle_39_mean REAL,
    angle_40_count BIGINT,
    angle_41_count BIGINT,
    angle_42_count BIGINT,
    angle_43_count BIGINT,
    angle_44_count BIGINT,
    angle_45_count BIGINT,
    angle_46_count BIGINT,
    angle_47_count BIGINT,
    angle_48_count BIGINT,
    angle_49_count BIGINT,
    angle_50_count BIGINT,
    angle_51_count BIGINT,
    angle_52_count BIGINT,
    angle_53_unique_count BIGINT,
    angle_54_unique_count BIGINT,
    angle_55_count BIGINT,
    angle_56_count BIGINT,
    angle_57_count BIGINT,
    angle_58_count BIGINT,
    angle_59_count BIGINT,
    angle_60_count BIGINT,
    angle_61_count BIGINT,
    angle_62_count BIGINT,
    angle_63_count BIGINT,
    angle_64_count BIGINT,
    angle_65_count BIGINT,
    angle_66_count BIGINT,
    angle_67_count BIGINT,
    angle_68_count BIGINT,
    angle_69_count BIGINT,
    angle_70_count BIGINT,
    angle_71_count BIGINT,
    angle_72_count BIGINT,
    angle_73_count BIGINT,
    angle_74_count BIGINT,
    angle_75_count BIGINT,
    angle_76_count BIGINT,
    angle_77_count BIGINT,
    angle_78_count BIGINT,
    angle_79_count BIGINT,
    angle_80_count BIGINT,
    angle_81_count BIGINT,
    angle_82_count BIGINT,
    angle_83_count BIGINT,
    angle_84_count BIGINT,
    angle_85_count BIGINT,
    angle_86_count BIGINT,
    angle_87_count BIGINT,
    angle_88_count BIGINT,
    angle_89_count BIGINT,
    angle_90_count BIGINT,
    angle_91_count BIGINT,
    angle_92_count BIGINT,
    angle_93_count BIGINT,
    angle_94_count BIGINT,
    angle_95_count BIGINT,
    angle_96_count BIGINT,
    angle_97_count BIGINT,
    angle_98_count BIGINT,
    angle_99_count BIGINT,
    angle_100_count BIGINT,
    angle_101_count BIGINT,
    angle_102_count BIGINT,
    angle_103_count BIGINT,
    angle_104_count BIGINT,
    angle_105_count BIGINT,
    angle_106_count BIGINT,
    angle_107_count BIGINT,
    angle_108_count BIGINT,
    angle_109_count BIGINT,
    angle_110_count BIGINT,
    angle_111_count BIGINT,
    angle_112_count BIGINT,
    angle_113_count BIGINT,
    angle_114_unique_count BIGINT,
    angle_115_unique_count BIGINT,
    angle_116_unique_count BIGINT,
    angle_117_unique_count BIGINT,
    angle_118_count BIGINT,
    angle_119_count BIGINT,
    angle_120_count BIGINT,
    angle_121_count BIGINT,
    angle_122_count BIGINT,
    angle_123_count BIGINT,
    angle_124_count BIGINT,
    angle_125_count BIGINT,
    angle_126_count BIGINT,
    angle_127_count BIGINT,
    angle_128_count BIGINT,
    angle_129_count BIGINT,
    angle_130_count BIGINT,
    angle_131_count BIGINT,
    angle_132_count BIGINT,
    angle_133_count BIGINT,
    angle_134_count BIGINT,
    angle_135_count BIGINT,
    angle_136_count BIGINT,
    angle_137_count BIGINT,
    angle_138_count BIGINT,
    angle_139_count BIGINT,
    angle_140_count BIGINT,
    angle_141_count BIGINT,
    angle_142_count BIGINT,
    angle_143_count BIGINT,
    angle_144_count BIGINT,
    angle_145_count BIGINT,
    angle_146_count BIGINT,
    angle_147_count BIGINT,
    angle_148_count BIGINT,
    angle_149_count BIGINT,
    angle_150_count BIGINT,
    angle_151_count BIGINT,
    angle_152_count BIGINT,
    angle_153_count BIGINT,
    angle_154_count BIGINT,
    angle_155_count BIGINT,
    angle_156_count BIGINT,
    angle_157_count BIGINT,
    angle_158_count BIGINT,
    angle_159_count BIGINT,
    angle_160_count BIGINT,
    angle_161_count BIGINT,
    angle_162_count BIGINT,
    angle_163_count BIGINT,
    angle_164_count BIGINT,
    angle_165_count BIGINT,
    angle_166_count BIGINT,
    angle_167_count BIGINT,
    angle_168_count BIGINT,
    angle_169_count BIGINT,
    angle_170_count BIGINT,
    angle_171_count BIGINT,
    angle_172_count BIGINT,
    angle_173_count BIGINT,
    angle_174_count BIGINT,
    angle_175_count BIGINT,
    angle_176_count BIGINT,
    angle_177_count BIGINT,
    angle_178_count BIGINT,
    angle_179_count BIGINT,
    angle_180_count BIGINT,
    angle_181_count BIGINT,
    angle_182_count BIGINT,
    angle_183_count BIGINT,
    angle_184_count BIGINT,
    angle_185_count BIGINT,
    angle_186_count BIGINT,
    angle_187_count BIGINT,
    angle_188_count BIGINT,
    angle_189_count BIGINT,
    angle_190_count BIGINT,
    angle_191_count BIGINT,
    angle_192_count BIGINT,
    angle_193_count BIGINT,
    angle_194_count BIGINT,
    angle_195_count BIGINT,
    angle_196_count BIGINT,
    angle_197_count BIGINT,
    angle_198_count BIGINT,
    angle_199_unique_fraction REAL,
    angle_200_unique_fraction REAL,
    angle_201_unique_fraction REAL,
    angle_202_count BIGINT,
    angle_203_count BIGINT,
    angle_204_count BIGINT,
    angle_205_count BIGINT,
    angle_206_count BIGINT,
    angle_207_count BIGINT,
    angle_208_count BIGINT,
    angle_209_count BIGINT,
    angle_210_count BIGINT,
    angle_211_count BIGINT,
    angle_212_count BIGINT,
    angle_213_count BIGINT,
    angle_214_count BIGINT,
    angle_215_count BIGINT,
    angle_216_count BIGINT,
    angle_217_count BIGINT,
    angle_218_count BIGINT,
    angle_219_count BIGINT,
    angle_220_count BIGINT,
    angle_221_count BIGINT,
    angle_222_count BIGINT,
    angle_223_count BIGINT,
    angle_224_count BIGINT,
    angle_225_count BIGINT,
    angle_226_count BIGINT,
    angle_227_count BIGINT,
    angle_228_count BIGINT,
    angle_229_count BIGINT,
    angle_230_count BIGINT,
    angle_231_count BIGINT,
    angle_232_count BIGINT,
    angle_233_count BIGINT,
    angle_234_mean REAL,
    angle_235_mean REAL,
    angle_236_mean REAL,
    angle_237_count BIGINT,
    angle_238_count BIGINT,
    angle_239_count BIGINT,
    angle_240_count BIGINT,
    angle_241_count BIGINT,
    angle_242_count BIGINT,
    angle_243_count BIGINT,
    angle_244_count BIGINT,
    angle_245_count BIGINT,
    angle_246_count BIGINT,
    angle_247_count BIGINT,
    angle_248_unique_fraction REAL,
    angle_249_unique_fraction REAL,
    angle_250_unique_fraction REAL,
    angle_251_count BIGINT,
    angle_252_count BIGINT,
    angle_253_count BIGINT,
    angle_254_count BIGINT,
    angle_255_count BIGINT,
    angle_256_count BIGINT,
    angle_257_count BIGINT,
    angle_258_count BIGINT,
    angle_259_count BIGINT,
    angle_260_count BIGINT,
    angle_261_count BIGINT,
    angle_262_count BIGINT,
    angle_263_count BIGINT,
    angle_264_count BIGINT,
    angle_265_count BIGINT,
    angle_266_count BIGINT,
    angle_267_count BIGINT,
    angle_268_count BIGINT,
    angle_269_count BIGINT,
    angle_270_count BIGINT,
    angle_271_count BIGINT,
    angle_272_unique_fraction REAL,
    angle_273_unique_fraction REAL,
    angle_274_unique_fraction REAL,
    angle_275_unique_fraction REAL,
    angle_276_count BIGINT,
    angle_277_count BIGINT,
    angle_278_count BIGINT,
    angle_279_count BIGINT,
    angle_280_count BIGINT,
    angle_281_count BIGINT,
    angle_282_count BIGINT,
    angle_283_count BIGINT,
    angle_284_count BIGINT,
    angle_285_count BIGINT,
    angle_286_count BIGINT,
    angle_287_count BIGINT,
    angle_288_count BIGINT,
    angle_289_count BIGINT,
    angle_290_count BIGINT,
    angle_291_count BIGINT,
    angle_292_count BIGINT,
    angle_293_count BIGINT,
    angle_294_count BIGINT,
    angle_295_count BIGINT,
    angle_296_count BIGINT,
    angle_297_count BIGINT,
    angle_298_count BIGINT,
    angle_299_count BIGINT,
    angle_300_count BIGINT,
    angle_301_count BIGINT,
    angle_302_count BIGINT,
    angle_303_count BIGINT,
    angle_304_count BIGINT,
    angle_305_min REAL,
    angle_306_min REAL,
    angle_307_min REAL,
    angle_308_count BIGINT,
    angle_309_count BIGINT,
    angle_310_count BIGINT,
    angle_311_count BIGINT,
    angle_312_count BIGINT,
    angle_313_count BIGINT,
    angle_314_count BIGINT,
    angle_315_count BIGINT,
    angle_316_count BIGINT,
    angle_317_count BIGINT,
    angle_318_count BIGINT,
    angle_319_count BIGINT,
    angle_320_count BIGINT,
    angle_321_count BIGINT,
    angle_322_count BIGINT,
    angle_323_count BIGINT,
    angle_324_count BIGINT,
    angle_325_count BIGINT,
    angle_326_count BIGINT,
    angle_327_count BIGINT,
    angle_328_count BIGINT,
    angle_329_count BIGINT,
    angle_330_count BIGINT,
    angle_331_sum REAL,
    angle_332_sum REAL,
    angle_333_sum REAL,
    angle_334_median REAL,
    angle_335_median REAL,
    angle_336_median REAL,
    angle_337_median REAL,
    angle_338_missing_fraction REAL,
    angle_339_missing_fraction REAL,
    angle_340_missing_fraction REAL,
    angle_341_missing_fraction REAL,
    angle_342_count BIGINT,
    angle_343_count BIGINT,
    angle_344_count BIGINT,
    angle_345_count BIGINT,
    angle_346_count BIGINT,
    angle_347_count BIGINT,
    angle_348_count BIGINT,
    angle_349_count BIGINT,
    angle_350_count BIGINT,
    angle_351_count BIGINT,
    angle_352_count BIGINT,
    angle_353_count BIGINT,
    angle_354_count BIGINT,
    angle_355_count BIGINT,
    angle_356_count BIGINT,
    angle_357_count BIGINT,
    angle_358_count BIGINT,
    angle_359_count BIGINT,
    angle_360_count BIGINT,
    angle_361_count BIGINT,
    angle_362_count BIGINT,
    angle_363_count BIGINT,
    angle_364_distinct_count BIGINT,
    angle_365_count BIGINT,
    angle_366_count BIGINT,
    angle_367_count BIGINT,
    angle_368_count BIGINT,
    angle_369_count BIGINT,
    angle_370_count BIGINT,
    angle_371_count BIGINT,
    angle_372_count BIGINT,
    angle_373_count BIGINT,
    angle_374_count BIGINT,
    angle_375_count BIGINT,
    angle_376_count BIGINT,
    angle_377_count BIGINT,
    angle_378_count BIGINT,
    angle_379_count BIGINT,
    angle_380_count BIGINT,
    angle_381_count BIGINT,
    angle_382_count BIGINT,
    angle_383_count BIGINT,
    angle_384_count BIGINT,
    angle_385_count BIGINT,
    angle_386_count BIGINT,
    angle_387_count BIGINT,
    angle_388_count BIGINT,
    angle_389_count BIGINT,
    angle_390_count BIGINT,
    angle_391_count BIGINT,
    angle_392_count BIGINT,
    angle_393_max REAL,
    angle_394_max REAL,
    angle_395_max REAL,
    angle_396_count BIGINT,
    angle_397_count BIGINT,
    angle_398_count BIGINT,
    angle_399_count BIGINT,
    angle_400_count BIGINT,
    angle_401_count BIGINT,
    angle_402_count BIGINT,
    angle_403_count BIGINT,
    angle_404_count BIGINT,
    angle_405_count BIGINT,
    angle_406_count BIGINT,
    angle_407_count BIGINT,
    angle_408_count BIGINT,
    angle_409_count BIGINT,
    angle_410_count BIGINT,
    angle_411_count BIGINT,
    angle_412_count BIGINT,
    angle_413_count BIGINT,
    angle_414_count BIGINT,
    angle_415_count BIGINT,
    angle_416_count BIGINT,
    angle_417_missing_fraction REAL,
    angle_418_missing_fraction REAL,
    angle_419_missing_fraction REAL,
    angle_420_missing_fraction REAL,
    angle_421_count BIGINT,
    angle_422_count BIGINT,
    angle_423_count BIGINT,
    angle_424_count BIGINT,
    angle_425_count BIGINT,
    angle_426_count BIGINT,
    angle_427_count BIGINT,
    angle_428_count BIGINT,
    angle_429_count BIGINT,
    angle_430_count BIGINT,
    angle_431_count BIGINT,
    angle_432_count BIGINT,
    angle_433_distinct_count BIGINT,
    angle_434_count BIGINT,
    angle_435_count BIGINT,
    angle_436_count BIGINT,
    angle_437_count BIGINT,
    angle_438_count BIGINT,
    angle_439_count BIGINT,
    angle_440_count BIGINT,
    angle_441_count BIGINT,
    angle_442_count BIGINT,
    angle_443_count BIGINT,
    angle_444_count BIGINT,
    angle_445_count BIGINT,
    angle_446_count BIGINT,
    angle_447_count BIGINT,
    angle_448_count BIGINT,
    angle_449_count BIGINT,
    angle_450_count BIGINT,
    angle_451_count BIGINT,
    angle_452_count BIGINT,
    angle_453_count BIGINT,
    angle_454_count BIGINT,
    angle_455_distinct_count BIGINT,
    angle_456_distinct_count BIGINT,
    angle_457_distinct_count BIGINT,
    angle_458_distinct_count BIGINT,
    angle_459_distinct_count BIGINT,
    angle_460_distinct_count BIGINT,
    angle_461_count BIGINT,
    angle_462_count BIGINT,
    angle_463_count BIGINT,
    angle_464_count BIGINT,
    angle_465_count BIGINT,
    angle_466_count BIGINT,
    angle_467_count BIGINT,
    angle_468_count BIGINT,
    angle_469_count BIGINT,
    angle_470_count BIGINT,
    angle_471_count BIGINT,
    angle_472_count BIGINT,
    angle_473_count BIGINT,
    angle_474_count BIGINT,
    angle_475_count BIGINT,
    angle_476_count BIGINT,
    angle_477_count BIGINT,
    angle_478_count BIGINT,
    angle_479_count BIGINT,
    angle_480_count BIGINT,
    angle_481_count BIGINT,
    angle_482_count BIGINT,
    angle_483_count BIGINT,
    angle_484_count BIGINT,
    angle_485_count BIGINT,
    angle_486_count BIGINT,
    angle_487_count BIGINT,
    angle_488_min REAL,
    angle_489_min REAL,
    angle_490_min REAL,
    angle_491_mean REAL,
    angle_492_mean REAL,
    angle_493_mean REAL,
    angle_494_max REAL,
    angle_495_max REAL,
    angle_496_max REAL,
    angle_497_max REAL,
    angle_498_max REAL,
    angle_499_max REAL,
    diff INTEGER,
    time BIGINT,
    kafka_time BIGINT,
    created_at TIMESTAMPTZ DEFAULT now()
    );
    """).format(table=sql.Identifier(STREAMDAQ_TABLE))
    with conn.cursor() as cur:
        cur.execute(create_sql)
    conn.commit()

def write_results_to_performance(message_value: dict, conn) -> None:
    """
    Inserts one row per tool into Postgres for the provided blast_info.
    """
    window_start = message_value.get('window_start', -1) # in seconds
    window_end = message_value.get('window_end', -1)    # in seconds
    window_setting = get_window_short_name(WINDOW_TYPE, WINDOW_DURATION_STR, SLIDE_DURATION_STR, GAP_DURATION_STR)
    number_of_cores = NUM_CORES
    number_of_threads = NUM_THREADS
    latency = (message_value.get('kafka_time') - message_value.get('time')) / 1000  # in seconds
    # Throughput is calculated as number of events divided by latency
    throughput = message_value.get('angle_0_count') / latency  # events per second

    insert_sql = sql.SQL("""
    INSERT INTO {table} (
        window_start, window_end, window_setting, number_of_cores, number_of_threads,
        latency, throughput
    ) VALUES (
        %s, %s, %s, %s, %s, %s, %s
    )
    """).format(table=sql.Identifier(PERFORMANCE_TABLE_NAME))

    with conn.cursor() as cur:
        params = (
            window_start,
            window_end,
            window_setting,
            number_of_cores,
            number_of_threads,
            latency,
            throughput
        )
        cur.execute(insert_sql, params)
    conn.commit()
    print(f"Inserted performance rows for window={window_start}-{window_end} into table {PERFORMANCE_TABLE_NAME}")


def write_results_to_dq(message_value: dict, conn) -> None:
    """Write data quality results to PostgreSQL database."""

    # Extract values from message_value dict
    values = [
        message_value.get('window_start'),
        message_value.get('window_end'),
        message_value.get('angle_0_count'),
        message_value.get('angle_1_mean'),
        message_value.get('angle_2_count'),
        message_value.get('angle_3_count'),
        message_value.get('angle_4_count'),
        message_value.get('angle_5_count'),
        message_value.get('angle_6_mean'),
        message_value.get('angle_7_mean'),
        message_value.get('angle_8_mean'),
        message_value.get('angle_9_min'),
        message_value.get('angle_10_min'),
        message_value.get('angle_11_min'),
        message_value.get('angle_12_min'),
        message_value.get('angle_13_min'),
        message_value.get('angle_14_max'),
        message_value.get('angle_15_max'),
        message_value.get('angle_16_count'),
        message_value.get('angle_17_count'),
        message_value.get('angle_18_count'),
        message_value.get('angle_19_count'),
        message_value.get('angle_20_count'),
        message_value.get('angle_21_count'),
        message_value.get('angle_22_count'),
        message_value.get('angle_23_count'),
        message_value.get('angle_24_count'),
        message_value.get('angle_25_count'),
        message_value.get('angle_26_count'),
        message_value.get('angle_27_count'),
        message_value.get('angle_28_count'),
        message_value.get('angle_29_count'),
        message_value.get('angle_30_count'),
        message_value.get('angle_31_count'),
        message_value.get('angle_32_count'),
        message_value.get('angle_33_max'),
        message_value.get('angle_34_max'),
        message_value.get('angle_35_max'),
        message_value.get('angle_36_mean'),
        message_value.get('angle_37_mean'),
        message_value.get('angle_38_mean'),
        message_value.get('angle_39_mean'),
        message_value.get('angle_40_count'),
        message_value.get('angle_41_count'),
        message_value.get('angle_42_count'),
        message_value.get('angle_43_count'),
        message_value.get('angle_44_count'),
        message_value.get('angle_45_count'),
        message_value.get('angle_46_count'),
        message_value.get('angle_47_count'),
        message_value.get('angle_48_count'),
        message_value.get('angle_49_count'),
        message_value.get('angle_50_count'),
        message_value.get('angle_51_count'),
        message_value.get('angle_52_count'),
        message_value.get('angle_53_unique_count'),
        message_value.get('angle_54_unique_count'),
        message_value.get('angle_55_count'),
        message_value.get('angle_56_count'),
        message_value.get('angle_57_count'),
        message_value.get('angle_58_count'),
        message_value.get('angle_59_count'),
        message_value.get('angle_60_count'),
        message_value.get('angle_61_count'),
        message_value.get('angle_62_count'),
        message_value.get('angle_63_count'),
        message_value.get('angle_64_count'),
        message_value.get('angle_65_count'),
        message_value.get('angle_66_count'),
        message_value.get('angle_67_count'),
        message_value.get('angle_68_count'),
        message_value.get('angle_69_count'),
        message_value.get('angle_70_count'),
        message_value.get('angle_71_count'),
        message_value.get('angle_72_count'),
        message_value.get('angle_73_count'),
        message_value.get('angle_74_count'),
        message_value.get('angle_75_count'),
        message_value.get('angle_76_count'),
        message_value.get('angle_77_count'),
        message_value.get('angle_78_count'),
        message_value.get('angle_79_count'),
        message_value.get('angle_80_count'),
        message_value.get('angle_81_count'),
        message_value.get('angle_82_count'),
        message_value.get('angle_83_count'),
        message_value.get('angle_84_count'),
        message_value.get('angle_85_count'),
        message_value.get('angle_86_count'),
        message_value.get('angle_87_count'),
        message_value.get('angle_88_count'),
        message_value.get('angle_89_count'),
        message_value.get('angle_90_count'),
        message_value.get('angle_91_count'),
        message_value.get('angle_92_count'),
        message_value.get('angle_93_count'),
        message_value.get('angle_94_count'),
        message_value.get('angle_95_count'),
        message_value.get('angle_96_count'),
        message_value.get('angle_97_count'),
        message_value.get('angle_98_count'),
        message_value.get('angle_99_count'),
        message_value.get('angle_100_count'),
        message_value.get('angle_101_count'),
        message_value.get('angle_102_count'),
        message_value.get('angle_103_count'),
        message_value.get('angle_104_count'),
        message_value.get('angle_105_count'),
        message_value.get('angle_106_count'),
        message_value.get('angle_107_count'),
        message_value.get('angle_108_count'),
        message_value.get('angle_109_count'),
        message_value.get('angle_110_count'),
        message_value.get('angle_111_count'),
        message_value.get('angle_112_count'),
        message_value.get('angle_113_count'),
        message_value.get('angle_114_unique_count'),
        message_value.get('angle_115_unique_count'),
        message_value.get('angle_116_unique_count'),
        message_value.get('angle_117_unique_count'),
        message_value.get('angle_118_count'),
        message_value.get('angle_119_count'),
        message_value.get('angle_120_count'),
        message_value.get('angle_121_count'),
        message_value.get('angle_122_count'),
        message_value.get('angle_123_count'),
        message_value.get('angle_124_count'),
        message_value.get('angle_125_count'),
        message_value.get('angle_126_count'),
        message_value.get('angle_127_count'),
        message_value.get('angle_128_count'),
        message_value.get('angle_129_count'),
        message_value.get('angle_130_count'),
        message_value.get('angle_131_count'),
        message_value.get('angle_132_count'),
        message_value.get('angle_133_count'),
        message_value.get('angle_134_count'),
        message_value.get('angle_135_count'),
        message_value.get('angle_136_count'),
        message_value.get('angle_137_count'),
        message_value.get('angle_138_count'),
        message_value.get('angle_139_count'),
        message_value.get('angle_140_count'),
        message_value.get('angle_141_count'),
        message_value.get('angle_142_count'),
        message_value.get('angle_143_count'),
        message_value.get('angle_144_count'),
        message_value.get('angle_145_count'),
        message_value.get('angle_146_count'),
        message_value.get('angle_147_count'),
        message_value.get('angle_148_count'),
        message_value.get('angle_149_count'),
        message_value.get('angle_150_count'),
        message_value.get('angle_151_count'),
        message_value.get('angle_152_count'),
        message_value.get('angle_153_count'),
        message_value.get('angle_154_count'),
        message_value.get('angle_155_count'),
        message_value.get('angle_156_count'),
        message_value.get('angle_157_count'),
        message_value.get('angle_158_count'),
        message_value.get('angle_159_count'),
        message_value.get('angle_160_count'),
        message_value.get('angle_161_count'),
        message_value.get('angle_162_count'),
        message_value.get('angle_163_count'),
        message_value.get('angle_164_count'),
        message_value.get('angle_165_count'),
        message_value.get('angle_166_count'),
        message_value.get('angle_167_count'),
        message_value.get('angle_168_count'),
        message_value.get('angle_169_count'),
        message_value.get('angle_170_count'),
        message_value.get('angle_171_count'),
        message_value.get('angle_172_count'),
        message_value.get('angle_173_count'),
        message_value.get('angle_174_count'),
        message_value.get('angle_175_count'),
        message_value.get('angle_176_count'),
        message_value.get('angle_177_count'),
        message_value.get('angle_178_count'),
        message_value.get('angle_179_count'),
        message_value.get('angle_180_count'),
        message_value.get('angle_181_count'),
        message_value.get('angle_182_count'),
        message_value.get('angle_183_count'),
        message_value.get('angle_184_count'),
        message_value.get('angle_185_count'),
        message_value.get('angle_186_count'),
        message_value.get('angle_187_count'),
        message_value.get('angle_188_count'),
        message_value.get('angle_189_count'),
        message_value.get('angle_190_count'),
        message_value.get('angle_191_count'),
        message_value.get('angle_192_count'),
        message_value.get('angle_193_count'),
        message_value.get('angle_194_count'),
        message_value.get('angle_195_count'),
        message_value.get('angle_196_count'),
        message_value.get('angle_197_count'),
        message_value.get('angle_198_count'),
        message_value.get('angle_199_unique_fraction'),
        message_value.get('angle_200_unique_fraction'),
        message_value.get('angle_201_unique_fraction'),
        message_value.get('angle_202_count'),
        message_value.get('angle_203_count'),
        message_value.get('angle_204_count'),
        message_value.get('angle_205_count'),
        message_value.get('angle_206_count'),
        message_value.get('angle_207_count'),
        message_value.get('angle_208_count'),
        message_value.get('angle_209_count'),
        message_value.get('angle_210_count'),
        message_value.get('angle_211_count'),
        message_value.get('angle_212_count'),
        message_value.get('angle_213_count'),
        message_value.get('angle_214_count'),
        message_value.get('angle_215_count'),
        message_value.get('angle_216_count'),
        message_value.get('angle_217_count'),
        message_value.get('angle_218_count'),
        message_value.get('angle_219_count'),
        message_value.get('angle_220_count'),
        message_value.get('angle_221_count'),
        message_value.get('angle_222_count'),
        message_value.get('angle_223_count'),
        message_value.get('angle_224_count'),
        message_value.get('angle_225_count'),
        message_value.get('angle_226_count'),
        message_value.get('angle_227_count'),
        message_value.get('angle_228_count'),
        message_value.get('angle_229_count'),
        message_value.get('angle_230_count'),
        message_value.get('angle_231_count'),
        message_value.get('angle_232_count'),
        message_value.get('angle_233_count'),
        message_value.get('angle_234_mean'),
        message_value.get('angle_235_mean'),
        message_value.get('angle_236_mean'),
        message_value.get('angle_237_count'),
        message_value.get('angle_238_count'),
        message_value.get('angle_239_count'),
        message_value.get('angle_240_count'),
        message_value.get('angle_241_count'),
        message_value.get('angle_242_count'),
        message_value.get('angle_243_count'),
        message_value.get('angle_244_count'),
        message_value.get('angle_245_count'),
        message_value.get('angle_246_count'),
        message_value.get('angle_247_count'),
        message_value.get('angle_248_unique_fraction'),
        message_value.get('angle_249_unique_fraction'),
        message_value.get('angle_250_unique_fraction'),
        message_value.get('angle_251_count'),
        message_value.get('angle_252_count'),
        message_value.get('angle_253_count'),
        message_value.get('angle_254_count'),
        message_value.get('angle_255_count'),
        message_value.get('angle_256_count'),
        message_value.get('angle_257_count'),
        message_value.get('angle_258_count'),
        message_value.get('angle_259_count'),
        message_value.get('angle_260_count'),
        message_value.get('angle_261_count'),
        message_value.get('angle_262_count'),
        message_value.get('angle_263_count'),
        message_value.get('angle_264_count'),
        message_value.get('angle_265_count'),
        message_value.get('angle_266_count'),
        message_value.get('angle_267_count'),
        message_value.get('angle_268_count'),
        message_value.get('angle_269_count'),
        message_value.get('angle_270_count'),
        message_value.get('angle_271_count'),
        message_value.get('angle_272_unique_fraction'),
        message_value.get('angle_273_unique_fraction'),
        message_value.get('angle_274_unique_fraction'),
        message_value.get('angle_275_unique_fraction'),
        message_value.get('angle_276_count'),
        message_value.get('angle_277_count'),
        message_value.get('angle_278_count'),
        message_value.get('angle_279_count'),
        message_value.get('angle_280_count'),
        message_value.get('angle_281_count'),
        message_value.get('angle_282_count'),
        message_value.get('angle_283_count'),
        message_value.get('angle_284_count'),
        message_value.get('angle_285_count'),
        message_value.get('angle_286_count'),
        message_value.get('angle_287_count'),
        message_value.get('angle_288_count'),
        message_value.get('angle_289_count'),
        message_value.get('angle_290_count'),
        message_value.get('angle_291_count'),
        message_value.get('angle_292_count'),
        message_value.get('angle_293_count'),
        message_value.get('angle_294_count'),
        message_value.get('angle_295_count'),
        message_value.get('angle_296_count'),
        message_value.get('angle_297_count'),
        message_value.get('angle_298_count'),
        message_value.get('angle_299_count'),
        message_value.get('angle_300_count'),
        message_value.get('angle_301_count'),
        message_value.get('angle_302_count'),
        message_value.get('angle_303_count'),
        message_value.get('angle_304_count'),
        message_value.get('angle_305_min'),
        message_value.get('angle_306_min'),
        message_value.get('angle_307_min'),
        message_value.get('angle_308_count'),
        message_value.get('angle_309_count'),
        message_value.get('angle_310_count'),
        message_value.get('angle_311_count'),
        message_value.get('angle_312_count'),
        message_value.get('angle_313_count'),
        message_value.get('angle_314_count'),
        message_value.get('angle_315_count'),
        message_value.get('angle_316_count'),
        message_value.get('angle_317_count'),
        message_value.get('angle_318_count'),
        message_value.get('angle_319_count'),
        message_value.get('angle_320_count'),
        message_value.get('angle_321_count'),
        message_value.get('angle_322_count'),
        message_value.get('angle_323_count'),
        message_value.get('angle_324_count'),
        message_value.get('angle_325_count'),
        message_value.get('angle_326_count'),
        message_value.get('angle_327_count'),
        message_value.get('angle_328_count'),
        message_value.get('angle_329_count'),
        message_value.get('angle_330_count'),
        message_value.get('angle_331_sum'),
        message_value.get('angle_332_sum'),
        message_value.get('angle_333_sum'),
        message_value.get('angle_334_median'),
        message_value.get('angle_335_median'),
        message_value.get('angle_336_median'),
        message_value.get('angle_337_median'),
        message_value.get('angle_338_missing_fraction'),
        message_value.get('angle_339_missing_fraction'),
        message_value.get('angle_340_missing_fraction'),
        message_value.get('angle_341_missing_fraction'),
        message_value.get('angle_342_count'),
        message_value.get('angle_343_count'),
        message_value.get('angle_344_count'),
        message_value.get('angle_345_count'),
        message_value.get('angle_346_count'),
        message_value.get('angle_347_count'),
        message_value.get('angle_348_count'),
        message_value.get('angle_349_count'),
        message_value.get('angle_350_count'),
        message_value.get('angle_351_count'),
        message_value.get('angle_352_count'),
        message_value.get('angle_353_count'),
        message_value.get('angle_354_count'),
        message_value.get('angle_355_count'),
        message_value.get('angle_356_count'),
        message_value.get('angle_357_count'),
        message_value.get('angle_358_count'),
        message_value.get('angle_359_count'),
        message_value.get('angle_360_count'),
        message_value.get('angle_361_count'),
        message_value.get('angle_362_count'),
        message_value.get('angle_363_count'),
        message_value.get('angle_364_distinct_count'),
        message_value.get('angle_365_count'),
        message_value.get('angle_366_count'),
        message_value.get('angle_367_count'),
        message_value.get('angle_368_count'),
        message_value.get('angle_369_count'),
        message_value.get('angle_370_count'),
        message_value.get('angle_371_count'),
        message_value.get('angle_372_count'),
        message_value.get('angle_373_count'),
        message_value.get('angle_374_count'),
        message_value.get('angle_375_count'),
        message_value.get('angle_376_count'),
        message_value.get('angle_377_count'),
        message_value.get('angle_378_count'),
        message_value.get('angle_379_count'),
        message_value.get('angle_380_count'),
        message_value.get('angle_381_count'),
        message_value.get('angle_382_count'),
        message_value.get('angle_383_count'),
        message_value.get('angle_384_count'),
        message_value.get('angle_385_count'),
        message_value.get('angle_386_count'),
        message_value.get('angle_387_count'),
        message_value.get('angle_388_count'),
        message_value.get('angle_389_count'),
        message_value.get('angle_390_count'),
        message_value.get('angle_391_count'),
        message_value.get('angle_392_count'),
        message_value.get('angle_393_max'),
        message_value.get('angle_394_max'),
        message_value.get('angle_395_max'),
        message_value.get('angle_396_count'),
        message_value.get('angle_397_count'),
        message_value.get('angle_398_count'),
        message_value.get('angle_399_count'),
        message_value.get('angle_400_count'),
        message_value.get('angle_401_count'),
        message_value.get('angle_402_count'),
        message_value.get('angle_403_count'),
        message_value.get('angle_404_count'),
        message_value.get('angle_405_count'),
        message_value.get('angle_406_count'),
        message_value.get('angle_407_count'),
        message_value.get('angle_408_count'),
        message_value.get('angle_409_count'),
        message_value.get('angle_410_count'),
        message_value.get('angle_411_count'),
        message_value.get('angle_412_count'),
        message_value.get('angle_413_count'),
        message_value.get('angle_414_count'),
        message_value.get('angle_415_count'),
        message_value.get('angle_416_count'),
        message_value.get('angle_417_missing_fraction'),
        message_value.get('angle_418_missing_fraction'),
        message_value.get('angle_419_missing_fraction'),
        message_value.get('angle_420_missing_fraction'),
        message_value.get('angle_421_count'),
        message_value.get('angle_422_count'),
        message_value.get('angle_423_count'),
        message_value.get('angle_424_count'),
        message_value.get('angle_425_count'),
        message_value.get('angle_426_count'),
        message_value.get('angle_427_count'),
        message_value.get('angle_428_count'),
        message_value.get('angle_429_count'),
        message_value.get('angle_430_count'),
        message_value.get('angle_431_count'),
        message_value.get('angle_432_count'),
        message_value.get('angle_433_distinct_count'),
        message_value.get('angle_434_count'),
        message_value.get('angle_435_count'),
        message_value.get('angle_436_count'),
        message_value.get('angle_437_count'),
        message_value.get('angle_438_count'),
        message_value.get('angle_439_count'),
        message_value.get('angle_440_count'),
        message_value.get('angle_441_count'),
        message_value.get('angle_442_count'),
        message_value.get('angle_443_count'),
        message_value.get('angle_444_count'),
        message_value.get('angle_445_count'),
        message_value.get('angle_446_count'),
        message_value.get('angle_447_count'),
        message_value.get('angle_448_count'),
        message_value.get('angle_449_count'),
        message_value.get('angle_450_count'),
        message_value.get('angle_451_count'),
        message_value.get('angle_452_count'),
        message_value.get('angle_453_count'),
        message_value.get('angle_454_count'),
        message_value.get('angle_455_distinct_count'),
        message_value.get('angle_456_distinct_count'),
        message_value.get('angle_457_distinct_count'),
        message_value.get('angle_458_distinct_count'),
        message_value.get('angle_459_distinct_count'),
        message_value.get('angle_460_distinct_count'),
        message_value.get('angle_461_count'),
        message_value.get('angle_462_count'),
        message_value.get('angle_463_count'),
        message_value.get('angle_464_count'),
        message_value.get('angle_465_count'),
        message_value.get('angle_466_count'),
        message_value.get('angle_467_count'),
        message_value.get('angle_468_count'),
        message_value.get('angle_469_count'),
        message_value.get('angle_470_count'),
        message_value.get('angle_471_count'),
        message_value.get('angle_472_count'),
        message_value.get('angle_473_count'),
        message_value.get('angle_474_count'),
        message_value.get('angle_475_count'),
        message_value.get('angle_476_count'),
        message_value.get('angle_477_count'),
        message_value.get('angle_478_count'),
        message_value.get('angle_479_count'),
        message_value.get('angle_480_count'),
        message_value.get('angle_481_count'),
        message_value.get('angle_482_count'),
        message_value.get('angle_483_count'),
        message_value.get('angle_484_count'),
        message_value.get('angle_485_count'),
        message_value.get('angle_486_count'),
        message_value.get('angle_487_count'),
        message_value.get('angle_488_min'),
        message_value.get('angle_489_min'),
        message_value.get('angle_490_min'),
        message_value.get('angle_491_mean'),
        message_value.get('angle_492_mean'),
        message_value.get('angle_493_mean'),
        message_value.get('angle_494_max'),
        message_value.get('angle_495_max'),
        message_value.get('angle_496_max'),
        message_value.get('angle_497_max'),
        message_value.get('angle_498_max'),
        message_value.get('angle_499_max'),
        message_value.get('diff'),
        message_value.get('time'),
        message_value.get('kafka_time')
    ]

    # Create placeholders for all values
    placeholders = ", ".join(["%s"] * len(values))

    # Define table name (you'll need to define STREAMDAQ_TABLE)
    STREAMDAQ_TABLE = os.getenv('STREAMDAQ_TABLE', 'dq_results')

    # Create INSERT query
    insert_query = sql.SQL("""
    INSERT INTO {table} (
        window_start, window_end,
        angle_0_count, angle_1_mean, angle_2_count, angle_3_count, angle_4_count, angle_5_count,
        angle_6_mean, angle_7_mean, angle_8_mean, angle_9_min, angle_10_min, angle_11_min,
        angle_12_min, angle_13_min, angle_14_max, angle_15_max, angle_16_count, angle_17_count,
        angle_18_count, angle_19_count, angle_20_count, angle_21_count, angle_22_count, angle_23_count,
        angle_24_count, angle_25_count, angle_26_count, angle_27_count, angle_28_count, angle_29_count,
        angle_30_count, angle_31_count, angle_32_count, angle_33_max, angle_34_max, angle_35_max,
        angle_36_mean, angle_37_mean, angle_38_mean, angle_39_mean, angle_40_count, angle_41_count,
        angle_42_count, angle_43_count, angle_44_count, angle_45_count, angle_46_count, angle_47_count,
        angle_48_count, angle_49_count, angle_50_count, angle_51_count, angle_52_count, angle_53_unique_count,
        angle_54_unique_count, angle_55_count, angle_56_count, angle_57_count, angle_58_count,
        angle_59_count, angle_60_count, angle_61_count, angle_62_count, angle_63_count, angle_64_count,
        angle_65_count, angle_66_count, angle_67_count, angle_68_count, angle_69_count, angle_70_count,
        angle_71_count, angle_72_count, angle_73_count, angle_74_count, angle_75_count, angle_76_count,
        angle_77_count, angle_78_count, angle_79_count, angle_80_count, angle_81_count, angle_82_count,
        angle_83_count, angle_84_count, angle_85_count, angle_86_count, angle_87_count, angle_88_count,
        angle_89_count, angle_90_count, angle_91_count, angle_92_count, angle_93_count, angle_94_count,
        angle_95_count, angle_96_count, angle_97_count, angle_98_count, angle_99_count, angle_100_count,
        angle_101_count, angle_102_count, angle_103_count, angle_104_count, angle_105_count, angle_106_count,
        angle_107_count, angle_108_count, angle_109_count, angle_110_count, angle_111_count, angle_112_count,
        angle_113_count, angle_114_unique_count, angle_115_unique_count, angle_116_unique_count,
        angle_117_unique_count, angle_118_count, angle_119_count, angle_120_count, angle_121_count,
        angle_122_count, angle_123_count, angle_124_count, angle_125_count, angle_126_count, angle_127_count,
        angle_128_count, angle_129_count, angle_130_count, angle_131_count, angle_132_count, angle_133_count,
        angle_134_count, angle_135_count, angle_136_count, angle_137_count, angle_138_count, angle_139_count,
        angle_140_count, angle_141_count, angle_142_count, angle_143_count, angle_144_count, angle_145_count,
        angle_146_count, angle_147_count, angle_148_count, angle_149_count, angle_150_count, angle_151_count,
        angle_152_count, angle_153_count, angle_154_count, angle_155_count, angle_156_count, angle_157_count,
        angle_158_count, angle_159_count, angle_160_count, angle_161_count, angle_162_count, angle_163_count,
        angle_164_count, angle_165_count, angle_166_count, angle_167_count, angle_168_count, angle_169_count,
        angle_170_count, angle_171_count, angle_172_count, angle_173_count, angle_174_count, angle_175_count,
        angle_176_count, angle_177_count, angle_178_count, angle_179_count, angle_180_count, angle_181_count,
        angle_182_count, angle_183_count, angle_184_count, angle_185_count, angle_186_count, angle_187_count,
        angle_188_count, angle_189_count, angle_190_count, angle_191_count, angle_192_count, angle_193_count,
        angle_194_count, angle_195_count, angle_196_count, angle_197_count, angle_198_count,
        angle_199_unique_fraction, angle_200_unique_fraction, angle_201_unique_fraction, angle_202_count,
        angle_203_count, angle_204_count, angle_205_count, angle_206_count, angle_207_count, angle_208_count,
        angle_209_count, angle_210_count, angle_211_count, angle_212_count, angle_213_count, angle_214_count,
        angle_215_count, angle_216_count, angle_217_count, angle_218_count, angle_219_count, angle_220_count,
        angle_221_count, angle_222_count, angle_223_count, angle_224_count, angle_225_count, angle_226_count,
        angle_227_count, angle_228_count, angle_229_count, angle_230_count, angle_231_count, angle_232_count,
        angle_233_count, angle_234_mean, angle_235_mean, angle_236_mean, angle_237_count, angle_238_count,
        angle_239_count, angle_240_count, angle_241_count, angle_242_count, angle_243_count, angle_244_count,
        angle_245_count, angle_246_count, angle_247_count, angle_248_unique_fraction, angle_249_unique_fraction,
        angle_250_unique_fraction, angle_251_count, angle_252_count, angle_253_count, angle_254_count,
        angle_255_count, angle_256_count, angle_257_count, angle_258_count, angle_259_count, angle_260_count,
        angle_261_count, angle_262_count, angle_263_count, angle_264_count, angle_265_count, angle_266_count,
        angle_267_count, angle_268_count, angle_269_count, angle_270_count, angle_271_count,
        angle_272_unique_fraction, angle_273_unique_fraction, angle_274_unique_fraction, angle_275_unique_fraction,
        angle_276_count, angle_277_count, angle_278_count, angle_279_count, angle_280_count, angle_281_count,
        angle_282_count, angle_283_count, angle_284_count, angle_285_count, angle_286_count, angle_287_count,
        angle_288_count, angle_289_count, angle_290_count, angle_291_count, angle_292_count, angle_293_count,
        angle_294_count, angle_295_count, angle_296_count, angle_297_count, angle_298_count, angle_299_count,
        angle_300_count, angle_301_count, angle_302_count, angle_303_count, angle_304_count, angle_305_min,
        angle_306_min, angle_307_min, angle_308_count, angle_309_count, angle_310_count, angle_311_count,
        angle_312_count, angle_313_count, angle_314_count, angle_315_count, angle_316_count, angle_317_count,
        angle_318_count, angle_319_count, angle_320_count, angle_321_count, angle_322_count, angle_323_count,
        angle_324_count, angle_325_count, angle_326_count, angle_327_count, angle_328_count, angle_329_count,
        angle_330_count, angle_331_sum, angle_332_sum, angle_333_sum, angle_334_median, angle_335_median,
        angle_336_median, angle_337_median, angle_338_missing_fraction, angle_339_missing_fraction,
        angle_340_missing_fraction, angle_341_missing_fraction, angle_342_count, angle_343_count,
        angle_344_count, angle_345_count, angle_346_count, angle_347_count, angle_348_count, angle_349_count,
        angle_350_count, angle_351_count, angle_352_count, angle_353_count, angle_354_count, angle_355_count,
        angle_356_count, angle_357_count, angle_358_count, angle_359_count, angle_360_count, angle_361_count,
        angle_362_count, angle_363_count, angle_364_distinct_count, angle_365_count, angle_366_count,
        angle_367_count, angle_368_count, angle_369_count, angle_370_count, angle_371_count, angle_372_count,
        angle_373_count, angle_374_count, angle_375_count, angle_376_count, angle_377_count, angle_378_count,
        angle_379_count, angle_380_count, angle_381_count, angle_382_count, angle_383_count, angle_384_count,
        angle_385_count, angle_386_count, angle_387_count, angle_388_count, angle_389_count, angle_390_count,
        angle_391_count, angle_392_count, angle_393_max, angle_394_max, angle_395_max, angle_396_count,
        angle_397_count, angle_398_count, angle_399_count, angle_400_count, angle_401_count, angle_402_count,
        angle_403_count, angle_404_count, angle_405_count, angle_406_count, angle_407_count, angle_408_count,
        angle_409_count, angle_410_count, angle_411_count, angle_412_count, angle_413_count, angle_414_count,
        angle_415_count, angle_416_count, angle_417_missing_fraction, angle_418_missing_fraction,
        angle_419_missing_fraction, angle_420_missing_fraction, angle_421_count, angle_422_count,
        angle_423_count, angle_424_count, angle_425_count, angle_426_count, angle_427_count, angle_428_count,
        angle_429_count, angle_430_count, angle_431_count, angle_432_count, angle_433_distinct_count,
        angle_434_count, angle_435_count, angle_436_count, angle_437_count, angle_438_count, angle_439_count,
        angle_440_count, angle_441_count, angle_442_count, angle_443_count, angle_444_count, angle_445_count,
        angle_446_count, angle_447_count, angle_448_count, angle_449_count, angle_450_count, angle_451_count,
        angle_452_count, angle_453_count, angle_454_count, angle_455_distinct_count, angle_456_distinct_count,
        angle_457_distinct_count, angle_458_distinct_count, angle_459_distinct_count, angle_460_distinct_count,
        angle_461_count, angle_462_count, angle_463_count, angle_464_count, angle_465_count, angle_466_count,
        angle_467_count, angle_468_count, angle_469_count, angle_470_count, angle_471_count, angle_472_count,
        angle_473_count, angle_474_count, angle_475_count, angle_476_count, angle_477_count, angle_478_count,
        angle_479_count, angle_480_count, angle_481_count, angle_482_count, angle_483_count, angle_484_count,
        angle_485_count, angle_486_count, angle_487_count, angle_488_min, angle_489_min, angle_490_min,
        angle_491_mean, angle_492_mean, angle_493_mean, angle_494_max, angle_495_max, angle_496_max,
        angle_497_max, angle_498_max, angle_499_max, diff, time, kafka_time
    ) VALUES ({placeholders})
    """).format(table=sql.Identifier(STREAMDAQ_TABLE), placeholders=sql.SQL(placeholders))

    # Execute the query
    with conn.cursor() as cursor:
        cursor.execute(insert_query, values)
        conn.commit()


def main():
    # Create Kafka consumer
    consumer = KafkaConsumer(
        OUTPUT_TOPIC,
        bootstrap_servers=KAFKA_BOOTSTRAP_SERVERS,
        auto_offset_reset='earliest',
        enable_auto_commit=True,
        value_deserializer=lambda m: json.loads(m.decode('utf-8'))
    )
    # Connect to Postgres
    conn = psycopg2.connect(
        host=PG_HOST,
        port=PG_PORT,
        dbname=PG_DB,
        user=PG_USER,
        password=PG_PASSWORD
    )
    create_performance_table_if_not_exists(conn)
    create_dq_table_if_not_exists(conn)

    try:
        i = 0
        for message in consumer:
            message_value = message.value  # Dictionary representing the message

            try:
                message_key = message.key.decode('utf-8') if message.key else "unknown"
            except Exception as e:
                message_key = "unknown"

            # Add the broker timestamp field to the dict
            message_value['kafka_time'] = message.timestamp # when kafka broker received the message; in ms

            # Write window results to DQ table
            if i % 10 == 0:
                write_results_to_dq(message_value, conn)

            # Compute performance metrics and write to performance table
            write_results_to_performance(message_value, conn)

            i += 1

    except KeyboardInterrupt:
        print("Stopping output consumer")
    finally:
        print("Reached the finally block. Closing consumer and DB connection...")
        try:
            consumer.close()
        except Exception:
            pass

        try:
            conn.close()
        except Exception:
            pass

if __name__ == "__main__":
    main()